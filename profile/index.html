<html>
  <head>
    <title>{user}'s Profile - wraithcode</title>
    <link rel="icon" href="/favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200..800&family=Pixelify+Sans:wght@400..700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="/text-assets/css/navandfooter.css">
	  <script src="/text-assets/js/setnavandfooter.js"></script>
	  <link rel="stylesheet" href="/text-assets/css/themes.css">
    <script src="/text-assets/js/theme.js"></script>
    <style>
      body {margin: 0; font-family: "Manrope"; color: var(--main-text-col); background: radial-gradient(ellipse at top left, var(--medium-2), var(--background)); padding-top: 80px;}
      .content {min-height: 100vh; width: calc(100% - 40px); padding: 0 20px; position: relative; display: flex; flex-direction: column; position: absolute; top: 0;}

      #banner {background: var(--medium-2); background-size: cover; background-position: center; height: 260px; width: 100%; display: flex; align-items: center; position: absolute; top: 0; left: 0;}
      .upperstuff-wrapper {height: calc(100% - 60px); width: calc(100% - 40px); position: absolute; bottom: 0; left: 0; display: flex; align-items: center; padding: 0 20px;}
      #pfp {background: var(--medium-1); background-size: cover; background-position: center; height: 150px; width: 150px; border-radius: 50%; border: 2px solid var(--main-text-col);}
      #username {font-size: 48px; font-weight: bold; height: 100%; width: calc(100% - 210px); margin: 0 15px; display: flex; align-items: center; position: absolute; top: 0; left: 175px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-shadow: 0 0 15px var(--background);}
      .folls {font-size: 14px; width: 100%; height: 20px; position: absolute; bottom: 10px; left: 0; display: flex;}
      .folls p {margin: 0; text-shadow: 0 0 15px var(--background);}
      #prof-followers button {background: var(--contrast-2); border: 1px solid var(--main-text-col); color: var(--main-text-col); border-radius: 30px; margin-left: 8px; height: 100%; transition: 0.2s ease-in-out;}
      #prof-followers button:hover {background: var(--contrast-1); cursor: pointer;}
      #prof-following {margin-left: 8px;}
      .badge {margin-left: 8px; height: 100%; aspect-ratio: 1/1;}

      .stats {background: var(--medium-2); padding: 10px; border-radius: 12px; width: 150px; position: absolute; top: 260px; left: 20px; margin-top: 15px; border-top: 1px solid var(--background); border-left: 1px solid var(--background);}
      .stats h4 {margin: 0; text-decoration: underline;}
      .stats p {margin: 0; margin-top: 5px;}
      .bio {height: calc(100% - 320px); width: calc(100% - 245px); background: var(--medium-2); position: absolute; top: 276px; right: 15px; border-radius: 10px; padding: 10px; border-top: 1px solid var(--background); border-left: 1px solid var(--background);}
        .bio:focus {border-left: 1px solid var(--main-text-col); border-right: 1px solid var(--main-text-col); outline: none;}
        .bio header {height: 30px; width: calc(100% - 20px); background: var(--medium-3); position: absolute; top: 0; left: 0; font-weight: bold; display: flex; align-items: center; padding: 0 10px; border-top-left-radius: 10px; border-top-right-radius: 10px;}
        .bio header i {position: absolute; right: 8px; cursor: pointer;}
        #prof-bio {height: calc(100% - 50px); width: calc(100% - 20px); position: absolute; top: 30px; left: 10px; padding: 10px 0; overflow-y: scroll;} 
        #prof-bio:focus {border-left: 1px solid var(--main-text-col); border-right: 1px solid var(--main-text-col); outline: none;}
        #prof-bio:focus::-webkit-scrollbar {width: 10px;}
        #prof-bio:focus::-webkit-scrollbar-track {background: var(--medium-2);}
        #prof-bio:focus::-webkit-scrollbar-thumb {background: var(--main-text-col);}
        #editingControls {height: 30px; width: calc(100% - 16px); background: var(--medium-3); position: absolute; top: 30px; left: 0; display: flex; align-items: center; padding: 0 8px; z-index: 2;}
        #editingControls i {margin: 0 5px; position: relative;}
        i:hover {color: var(--subtle-text-diff-col); cursor: pointer;}
        i:hover:after {content: attr(datalabel); position: absolute; bottom: -32px; left: 50%; transform: translateX(-50%); background-color: var(--medium-2); color: var(--main-text-col); padding: 5px 8px; border: 1px solid var(--subtle-text-diff-gry); border-radius: 5px; font-size: 12px; font-family: Manrope; font-weight: bold; white-space: nowrap; z-index: 3; pointer-events: none;}
        #colorpickerbutton {display: flex; align-items: center; justify-content: center;}
        #discard-edits {position: absolute; right: 38px;}
    </style>
  </head>
  <body>
    <nav id="navbar">
      <!-- setnavandfooter.js adds content here -->
    </nav>

    <div class="content">
      <div id="banner">
        <div class="upperstuff-wrapper">
          <div id="pfp"></div>
          <div id="username"><p id="prof-username">- -</p>
            <div class="folls">
              <p id="prof-followers">Followers: - - <button>Follow</button></p>
              <p id="prof-following">Following: - - </p>
              <div id="badges"></div>
            </div>
          </div>
        </div>
      </div>

        <div class="stats">
          <h4>Stats</h4>
          <p>Visits: <b id="prof-visits">0</b></p>
          <p>Joined: <b id="prof-joined">0</b></p>
        </div>

        <div class="bio">
          <header><p id="headerText">Bio</p><i class="fa fa-trash-can" id="discard-edits" datalabel="Discard Edits" onclick="discardEdits()"></i><i class="fa fa-pencil" id="edit-prof" datalabel="Edit Bio"></i></header>
          <div id="editingControls" style="display:none;">
              <i class="fa fa-bold" datalabel="Bold" onclick="text('bold');"></i>
              <i class="fa fa-italic" datalabel="Italic" onclick="text('italic');"></i>
              <i class="fa fa-underline" datalabel="Underline" onclick="text('underline');"></i>
              <i class="fa fa-strikethrough" datalabel="Strikethrough" onclick="text('strikeThrough');"></i>
              <i class="fa fa-palette" id="colorpickerbutton" datalabel="Text Color" onclick="openColorPicker()"><input type="color" id="colorpickerinput" style="display: block; pointer-events: none; opacity: 0; position: absolute; z-index: 999;"></i>
              <i class="fa fa-font" datalabel="Fonts"></i>
              <i class="fa fa-link" datalabel="Link"></i>
              <i class="fa-regular fa-image" datalabel="Images"></i>
              <i class="fa-regular fa-face-smile-wink" datalabel="Emojis"></i>
              <i class="fa-regular fa-id-badge" datalabel="Badges"></i>
              <i class="fa-regular fa-eye" style="position: absolute; right: 4px;" datalabel="Preview"></i>
          </div>
          <div id="prof-bio"></div>
      </div>

        <footer id="footer" style="position: absolute; top: 100%; height: 120px;">
            <!-- setnavandfooter.js adds content here -->
        </footer>
    </div>
    <script>
      async function getUserDataAndUpdateProfile() {
        // Get username from the URL
        const urlParams = new URLSearchParams(window.location.search);
        const username = urlParams.get('user');

        if (!username) {
          alert('Username not found in URL');
          return;
        }

        try {
          // Fetch data from the spreadsheet
          const response = await fetch('https://opensheet.elk.sh/1kPCHuc7uU4CSiC1z5MRAoEJOnuNMD5YLKNVqlBnXMXA/1');
          const data = await response.json();

          // Find the row corresponding to the username
          const userData = data.find(row => row.username === username);

          if (!userData) {
            alert('User data not found for username: ', username);
            return;
          }

          // Set variables with corresponding values
          var varUsernum = userData.usernum;
          var varUsername = userData.username;
          var varEmail = userData.email;
          var varPwd = userData.pwd;
          var varPfpChunk1 = userData.pfp_chunk1;
          var varPfpChunk2 = userData.pfp_chunk2;
          var fullPfp = varPfpChunk1 + varPfpChunk2;
          var varVisits = userData.visits;
          var varJoined = userData.joined;
          var varBio = userData.bio;
          var varBadges = userData.badges;
          var varFollowers = userData.followers;
          var varFollowing = userData.following;

          var profUsername = document.getElementById("prof-username");
          var profFollowers = document.getElementById("prof-followers");
          var profFollowing = document.getElementById("prof-following");
          var profVisits = document.getElementById("prof-visits");
          var profJoined = document.getElementById("prof-joined");
          var profPfp = document.getElementById("pfp");
          var profBanner = document.getElementById("banner");
          var profBio = document.getElementById("prof-bio");

          document.title = varUsername + '\'s Profile - wraithcode';
          profUsername.innerText = varUsername;
          profFollowers.innerHTML = 'Followers: ' + varFollowers + ' <button>Follow</button>';
          profFollowing.innerText = 'Following: ' + varFollowing;
          profVisits.innerText = varVisits;
          profJoined.innerText = varJoined;
          if (fullPfp == 'data:image/png;base64,') {
            const letterImageBase64 = createSquareImage(varUsername, 200, 'darkcyan', 'white', 100);
            profPfp.style.backgroundImage = 'url(' + letterImageBase64 + ')';
          } else {
            profPfp.style.backgroundImage = "url(" + fullPfp + ")";
          }
          profBanner.style.backgroundImage = "url(" + fullPfp + ")";
          loadBadges(varBadges);
          profBio.innerHTML = varBio;
          

        } catch (error) {
          alert('Error fetching user data:', error);
        }
      }

      function loadBadges(varBadgesString) {
        var badgesContainer = document.getElementById('badges');

        // Clear existing badges
        badgesContainer.innerHTML = '';

        // Split the string into an array using comma as the separator
        var varBadges = varBadgesString.split(',');

        // Loop through each badge item
        varBadges.forEach(function(badgeName) {
            // Create image element
            var img = document.createElement('img');
            img.className = "badge";
            
            // Set source attribute to the badge SVG
            img.src = '/profile/badges/' + badgeName.trim() + '.png';
            
            // Append image to badges container
            badgesContainer.appendChild(img);
        });
      }

      function createSquareImage(text, size, bgColor, textColor, fontSize) {
        const canvas = document.createElement('canvas');
        canvas.width = size;
        canvas.height = size;
        const ctx = canvas.getContext('2d');

        ctx.fillStyle = bgColor;
        ctx.fillRect(0, 0, size, size);

        ctx.font = `${fontSize}px Arial`;
        ctx.fillStyle = textColor;
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(text[0].toUpperCase(), size / 2, size / 2);

        const base64String = canvas.toDataURL();
        return base64String;
      }

        var editing = 0;
        var previewing = 0;
        var bioDiv = document.getElementById("prof-bio");
        var editingControls = document.getElementById("editingControls");
        var headerText = document.getElementById("headerText");
        var editProf = document.getElementById("edit-prof");
        var discardEdits = document.getElementById("discard-edits");
        var presavedBio;
        function preventFocusLoss(event) {
          if (!bioDiv.contains(event.target)) {
            event.preventDefault();
            bioDiv.focus();
          }
        }
        document.addEventListener('mousedown', preventFocusLoss);
        document.getElementById("edit-prof").addEventListener("click", toggleEditor);
        function toggleEditor() {
          presavedBio = bioDiv.innerHTML;
          editing = 1 - editing;
            if (editing == 1) {
                bioDiv.style.height = "calc(100% - 80px)";
                bioDiv.style.top = "60px";
                editingControls.style.display = "flex";
                editProf.classList.remove("fa-pencil");
                editProf.classList.add("fa-signature");
                editProf.setAttribute('datalabel', 'Save');
                headerText.innerText = "Editing Bio";
                discardEdits.style.display = 'block';
                bioDiv.contentEditable = true;
                bioDiv.focus();
            } else {
                bioDiv.style.height = "calc(100% - 50px)";
                bioDiv.style.top = "30px";
                editingControls.style.display = "none";
                editProf.classList.remove("fa-signature");
                editProf.classList.add("fa-pencil");
                editProf.setAttribute('datalabel', 'Edit Bio');
                headerText.innerText = "Bio";
                discardEdits.style.display = 'none';
                bioDiv.contentEditable = false;
                bioDiv.blur();
            }
        }

        discardEdits.addEventListener("click", function() {
          bioDiv.innerHTML = presavedBio;
          toggleEditor();
        });
        
        function openColorPicker() {
          var btn = document.getElementById('colorpickerbutton');
          var inp = document.getElementById('colorpickerinput');
          var btnRect = btn.getBoundingClientRect();
          inp.style.pointerEvents = 'all';
          inp.click();
          inp.style.pointerEvents = 'none';
        }
        document.getElementById('colorpickerinput').addEventListener('input', function() {
          var color = this.value;
          document.getElementById('colorpickerbutton').style.color = color;
          document.execCommand("foreColor", true, color);
        });
        bioDiv.addEventListener("click", function() {
          if (bioDiv.contentEditable == 'true') {
              document.addEventListener("selectionchange", function() {
                  var selection = window.getSelection();
                  var range = selection.getRangeAt(0);
                  var ancestor = range.commonAncestorContainer;
                  if (ancestor.nodeType !== 1) {
                      ancestor = ancestor.parentNode;
                  }
                  var computedStyle = window.getComputedStyle(ancestor);
                  var color = computedStyle.color;
                  document.getElementById('colorpickerbutton').style.color = color;
                  document.getElementById('colorpickerinput').value = rgbToHex(color);
              });
            }
        });
        const rgbToHex = (rgb) => {
          const [r, g, b] = rgb.substring(4, rgb.length - 1).split(',').map(Number);
          return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
        };

        var userSession = 'wraithcode';
        function getUserParam() {const urlParam = new URLSearchParams(window.location.search); const ret = urlParam.get('user'); return ret;}
        function checkSession() {
          if (userSession === getUserParam()) {
            editProf.style.display = "block";
          } else {
            editProf.style.display = "none";
          }
        }

        function text(e) {
          document.execCommand(e, true, null);
        }
    </script>
	  <script>
    	document.addEventListener("DOMContentLoaded", function (e) {
        	updateNavAndFooter();
          getUserDataAndUpdateProfile();
          checkSession();
          toggleEditor();
        });
    </script>
  </body>
</html>
